<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Sugerir un Lugar</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding-bottom">
  <ion-grid>
    <ion-row class="ion-justify-content-center">
      <ion-col size="12" size-md="8" size-lg="6">

        <ion-card>
          <ion-card-header>
            <ion-card-title class="ion-text-center">
              {{ isEditing ? 'Editar Lugar' : 'Sugerir un Lugar Turístico' }}
            </ion-card-title>
            <ion-card-subtitle class="ion-text-center">
              {{ isEditing ? 'Modificando información existente' : 'Comparte tu descubrimiento' }}
            </ion-card-subtitle>
          </ion-card-header>

          <ion-card-content>

            <form [formGroup]="suggestForm" (ngSubmit)="onSubmit()" class="ion-margin-top">
              <ion-list lines="none">

                <ion-item lines="full">
                  <ion-input label="Nombre del Lugar" labelPlacement="floating" type="text" formControlName="nombre"
                    autocomplete="off"></ion-input>
                </ion-item>
                @if (nombre?.invalid && nombre?.touched) {
                  <div class="error-container ion-padding-start">
                    @if (nombre?.hasError("required")) { <ion-note color="danger">El nombre es obligatorio.</ion-note> }
                    @if (nombre?.hasError("minlength")) { <ion-note color="danger">Mínimo 5 caracteres.</ion-note> }
                  </div>
                }

                <ion-item lines="full">
                  <ion-select label="Categoría" labelPlacement="floating" formControlName="categoria" interface="popover" placeholder="Selecciona una">
                    @for (cat of categorias; track cat) {
                      <ion-select-option [value]="cat">{{ cat }}</ion-select-option>
                    }
                  </ion-select>
                </ion-item>
                @if (categoria?.invalid && categoria?.touched) {
                  <div class="ion-padding-start">
                    <ion-note color="danger">Selecciona una categoría.</ion-note>
                  </div>
                }

                <ion-item lines="full">
                  <ion-textarea label="Descripción" labelPlacement="floating" formControlName="descripcion" autoGrow="true" [rows]="3"></ion-textarea>
                </ion-item>
                @if (descripcion?.invalid && descripcion?.touched) {
                  <div class="ion-padding-start">
                      @if (descripcion?.hasError("required")) { <ion-note color="danger">Descripción obligatoria.</ion-note> }
                      @if (descripcion?.hasError("minWords")) { <ion-note color="danger">Mínimo 8 palabras.</ion-note> }
                  </div>
                }

                <div class="section-divider ion-margin-top">
                  <ion-label color="primary"><strong>Foto del Lugar</strong></ion-label>
                </div>

                <ion-button expand="block" fill="outline" (click)="onTakePhoto()" [disabled]="loadingPhoto" class="ion-margin-vertical">
                  <ion-icon slot="start" name="camera"></ion-icon>
                  {{ photos.length > 0 ? 'Tomar Otra Foto' : 'Tomar Foto' }}
                </ion-button>

                @if (photos.length > 0) {
                  <ion-card class="photo-preview-card">
                    <img [src]="photos[0].webviewPath" alt="Foto del lugar" />
                    <div class="ion-text-end">
                      <ion-button fill="clear" color="danger" size="small" (click)="deletePhoto(photos[0])">
                        <ion-icon slot="icon-only" name="trash"></ion-icon>
                        Eliminar
                      </ion-button>
                    </div>
                  </ion-card>
                }



                <div class="section-divider ion-margin-top">
                  <ion-label color="primary"><strong>Ubicación</strong></ion-label>
                </div>

                <ion-button expand="block" fill="outline" color="secondary" (click)="getLocationOnce()" [disabled]="loadingLocation" class="ion-margin-vertical">
                  <ion-icon slot="start" name="location"></ion-icon>
                  Obtener Ubicación GPS
                </ion-button>

                @if (loadingLocation) {
                  <div class="ion-text-center ion-padding">
                    <ion-spinner name="crescent"></ion-spinner>
                    <p><small>Localizando...</small></p>
                  </div>
                }

                @if (mapUrlSafe) {
                  <div class="map-wrapper ion-margin-bottom">
                    <iframe [src]="mapUrlSafe" width="100%" height="200" style="border:0" loading="lazy"></iframe>
                    <ion-note color="medium" class="ion-text-center" style="display:block; font-size: 0.8rem;">
                      Lat: {{ lat }} | Lng: {{ lng }}
                    </ion-note>
                  </div>
                }
                
                @if (direccion?.invalid && direccion?.touched) {
                  <div class="ion-padding-start">
                    <ion-note color="danger">La dirección es obligatoria.</ion-note>
                  </div>
                }


                <ion-item lines="none" class="ion-margin-top">
                  <ion-label>Calificación ({{ calificacion?.value }} estrellas)</ion-label>
                </ion-item>
                <ion-range formControlName="calificacion" min="1" max="5" step="1" snaps="true" color="warning" pin="true">
                  <ion-icon slot="start" size="small" name="star-outline"></ion-icon>
                  <ion-icon slot="end" name="star"></ion-icon>
                </ion-range>

                <ion-item lines="full">
                  <ion-input label="Tu Email de Contacto" type="email" labelPlacement="floating" formControlName="contacto"></ion-input>
                </ion-item>
                @if (contacto?.invalid && contacto?.touched) {
                  <div class="ion-padding-start">
                      @if (contacto?.hasError("required")) { <ion-note color="danger">Email requerido.</ion-note> }
                      @if (contacto?.hasError("email")) { <ion-note color="danger">Formato inválido.</ion-note> }
                  </div>
                }

                <ion-button expand="full" type="submit" class="ion-margin-top" size="large" [disabled]="suggestForm.invalid" [color]="isEditing ? 'warning' : 'primary'">
                  {{ isEditing ? 'Actualizar Lugar' : 'Enviar Sugerencia' }}
                </ion-button>

                @if (isEditing) {
                  <ion-button expand="full" fill="outline" color="medium" class="ion-margin-top" (click)="cancelEdit()">
                    <ion-icon slot="start" name="close-circle"></ion-icon>
                    Cancelar Edición
                  </ion-button>
                }

              </ion-list>
            </form>

          </ion-card-content>
        </ion-card>



        <ion-list [inset]="true">
          @for (place of places; track place.id) {
            <ion-item-sliding>
              <ion-item>
                <ion-label>
                  <h2>{{ place.nombre }}</h2>
                  <p>{{ place.categoria }} • <ion-text color="warning">★ {{ place.calificacion }}</ion-text></p>
                </ion-label>
                <ion-button fill="clear" slot="end" (click)="onEdit(place)">
                  <ion-icon slot="icon-only" name="pencil"></ion-icon>
                </ion-button>
              </ion-item>

              <ion-item-options side="end">
                <ion-item-option color="danger" (click)="onDelete(place.id)">
                  <ion-icon slot="icon-only" name="trash"></ion-icon>
                </ion-item-option>
              </ion-item-options>
            </ion-item-sliding>
          } @empty {
            <ion-item lines="none">
              <ion-label class="ion-text-center" color="medium">
                <p>No hay lugares registrados aún.</p>
              </ion-label>
            </ion-item>
          }
        </ion-list>

      </ion-col>
    </ion-row>
  </ion-grid>
</ion-content>